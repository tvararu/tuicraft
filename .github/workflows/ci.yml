name: CI

on:
  push:
    branches: [main]
  pull_request:

env:
  MISE_TASK_TIMEOUT: 10s

permissions:
  contents: read
  pull-requests: write

jobs:
  format:
    name: format / prettier
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: jdx/mise-action@v3
        with: { cache: true, install: true }
      - run: mise bundle
      - run: mise format

  typecheck:
    name: typecheck / tsc
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: jdx/mise-action@v3
        with: { cache: true, install: true }
      - run: mise bundle
      - run: mise typecheck

  test:
    name: test / bun test --coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: jdx/mise-action@v3
        with: { cache: true, install: true }
      - run: mise bundle
      - name: Run tests with coverage
        run: mise test:coverage 2>&1 | tee /tmp/coverage.txt
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TABLE=$(sed -n '/^---/,/^Ran /p' /tmp/coverage.txt)
          BODY="<!-- coverage -->
          ## Test Coverage
          \`\`\`
          $TABLE
          \`\`\`"
          PR=${{ github.event.pull_request.number }}
          NODE_ID=$(gh pr view "$PR" --json comments \
            --jq '[.comments[] | select(.body | test("<!-- coverage -->"))][0].id // empty')
          if [ -n "$NODE_ID" ]; then
            gh api graphql \
              -F id="$NODE_ID" \
              -F body="$BODY" \
              -f query='mutation($id: ID!, $body: String!) {
                updateIssueComment(input: {id: $id, body: $body}) {
                  issueComment { id }
                }
              }'
          else
            gh pr comment "$PR" --body "$BODY"
          fi
