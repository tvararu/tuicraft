name: CI

on:
  push:
    branches: [main]
  pull_request:

env:
  MISE_TASK_TIMEOUT: 10s

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  format:
    name: format / prettier
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: jdx/mise-action@v3
        with: { cache: true, install: true }
      - run: mise bundle
      - run: mise format

  typecheck:
    name: typecheck / tsc
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: jdx/mise-action@v3
        with: { cache: true, install: true }
      - run: mise bundle
      - run: mise typecheck

  test:
    name: test / bun test --coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: jdx/mise-action@v3
        with: { cache: true, install: true }
      - run: mise bundle
      - name: Run tests with coverage
        run: mise test:coverage 2>&1 | tee /tmp/coverage.txt
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TABLE=$(sed -n '/^---/,/^Ran /p' /tmp/coverage.txt)
          BODY="<!-- coverage -->
          ## Test Coverage
          \`\`\`
          $TABLE
          \`\`\`"
          PR=${{ github.event.pull_request.number }}
          COMMENT_ID=$(gh api "repos/$GITHUB_REPOSITORY/issues/$PR/comments" \
            --jq '.[] | select(.body | contains("<!-- coverage -->")) | .id' | head -1)
          if [ -n "$COMMENT_ID" ]; then
            gh api "repos/$GITHUB_REPOSITORY/issues/$PR/comments/$COMMENT_ID" \
              -X PATCH -f body="$BODY"
          else
            gh pr comment "$PR" --body "$BODY"
          fi
