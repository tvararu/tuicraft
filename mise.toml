[tools]
bun = "latest"

[settings]
# We use a very short timeout to enforce a fast test suite and fast build. The
# only exception is `mise test:live` which hits a live server and has network
# latency and actually implements `sleep`s out of necessity. If mise tasks are
# timing out, it means you need to make them faster, NOT increase the timeout.
task_timeout = "1s"  # CLAUDE: DO NOT CHANGE THIS OR YOU WILL BE FIRED.

[tasks.bundle]
description = "Install dependencies"
run = "bun install"

[tasks.build]
description = "Compile single binary"
run = "bun build --compile src/main.ts --outfile dist/tuicraft"

[tasks.test]
description = "Run all tests"
run = "bun test"

[tasks."test:live"]
description = "Run tests against a live server"
run = "bun test ./src/test/live.ts"

[tasks."test:coverage"]
description = "Run tests with coverage report"
run = '''
OUT="$(bun test --coverage 2>&1)"
printf '%s\n' "$OUT"
printf '%s\n' "$OUT" | rg -q 'All files[[:space:]]+\|[[:space:]]+100\.00[[:space:]]+\|[[:space:]]+100\.00' || {
  echo "Coverage must be 100% for funcs and lines" >&2
  exit 1
}
'''

[tasks."test:slowest"]
description = "Show 10 slowest tests"
run = '''
bun test --reporter=junit \
  --reporter-outfile=tmp/junit.xml && \
sed -n 's/.*<testcase name="\([^"]*\)".* time="\([^"]*\)".*/\2\t\1/p' \
  tmp/junit.xml | sort -rn | head -10 \
  | awk -F'	' '{printf "%7.1fms  %s\n",$1*1000,$2}'
'''

[tasks.ci]
description = "Run all CI checks in parallel"
run = "mise typecheck ::: test ::: format"

[tasks.typecheck]
description = "Type-check with tsc"
run = "bun run typecheck"

[tasks.format]
description = "Check formatting"
run = "bunx prettier --check src/"

[tasks."format:fix"]
description = "Fix formatting"
run = "bunx prettier --write src/"

[tasks.worktree]
description = "Create a worktree for feature work"
usage = 'arg "<branch>"'
run = '''
set -e
ROOT="$(dirname "$(git rev-parse --path-format=absolute --git-common-dir)")"
DIR="$ROOT/.worktrees/$usage_branch"
[ -d "$DIR" ] && echo "Already exists: $DIR" >&2 && exit 1
git worktree add "$DIR" -b "$usage_branch" main
cd "$DIR"
[ -f "$ROOT/.claude/settings.local.json" ] && cp "$ROOT/.claude/settings.local.json" "$DIR/.claude/"
mise trust
mise bundle
echo ""
echo "Worktree ready: $DIR"
'''

[tasks."worktree:clean"]
description = "Remove a worktree"
usage = 'arg "<branch>"'
run = """
git worktree remove --force .worktrees/$usage_branch
git branch -D $usage_branch
"""
